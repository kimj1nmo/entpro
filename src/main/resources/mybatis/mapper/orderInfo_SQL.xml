<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.page.shop.mapper.OrderInfoMapper">

    <!-- 주문 정보 INSERT (시퀀스로 PK 미리 조회) -->
    <insert id="insertOrderInfo" parameterType="kr.or.ddit.vo.OrderInfoVO">
        
       
        <selectKey keyProperty="orderNo" resultType="int" order="BEFORE">
            SELECT order_no_seq.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO ORDER_INFO (
            ORDER_NO,
            ORDER_DATE,
            ORDER_TOTAL_AMOUNT,
            ORDER_ADD,
            MEM_ID,
            ORDER_NAME,
            USER_PHONE
        ) VALUES (
            #{orderNo},
            SYSDATE,
            #{orderTotalAmount},
            #{orderAdd},
            #{memId},
            #{orderName},
            #{userPhone}
        )
    </insert>
    <!-- 특정 회원(MEM_ID)의 주문 내역 조회 -->
<select id="selectOrdersByMemId" resultType="kr.or.ddit.vo.OrderInfoVO">
SELECT 
    oi.ORDER_NO, 
    oi.ORDER_DATE, 
    oi.ORDER_TOTAL_AMOUNT, 
    oi.ORDER_ADD AS orderAddress, 
    oi.MEM_ID, 
    oi.ORDER_NAME, 
    oi.USER_PHONE,
    oi.ORDER_CHANGE_NO, 
    ol.GDS_NO AS gdsNo,  
    ol.ORDER_LIST_QY AS orderListQy,
    g.GDS_NM AS gdsName,  
    g.GDS_PRICE AS gdsPrice 
FROM ORDER_INFO oi  
LEFT JOIN ORDER_LIST ol  
ON oi.ORDER_NO = ol.ORDER_NO
LEFT JOIN GOODS g  
ON ol.GDS_NO = g.GDS_NO  
WHERE oi.MEM_ID = #{memId}  
ORDER BY oi.ORDER_DATE DESC
</select>

<!-- 특정 회원의 주문 내역 조회 (ORDER_CHANGE_NO를 동적으로 설정) -->
<!--<select id="selectOrdersByMemIdAndStatus" resultType="kr.or.ddit.vo.OrderInfoVO">
SELECT 
    oi.ORDER_NO, 
    oi.ORDER_DATE, 
    oi.ORDER_TOTAL_AMOUNT, 
    oi.ORDER_ADD AS orderAddress, 
    oi.MEM_ID, 
    oi.ORDER_NAME, 
    oi.USER_PHONE, 
    ol.GDS_NO AS gdsNo,  
    ol.ORDER_LIST_QY AS orderListQy  
FROM ORDER_INFO oi  
LEFT JOIN ORDER_LIST ol  
ON oi.ORDER_NO = ol.ORDER_NO
WHERE oi.MEM_ID = #{memId} 
AND oi.ORDER_CHANGE_NO = #{orderChangeNo}  
</select>-->
<!--환불 요청-->
    <update id="updateOrderToRefund" parameterType="map">
        UPDATE ORDER_INFO
        SET ORDER_CHANGE_NO = #{orderChangeNo} 
        WHERE ORDER_NO = #{orderNo}
    </update>
    
</mapper>
