<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.page.shop.mapper.ReviewMapper">

    <!-- ✅ 리뷰 조회 매핑 -->
   <resultMap id="ReviewResultMap" type="kr.or.ddit.vo.ReviewVO">
    <id property="reNo" column="reNo"/>
    <result property="gdsNo" column="gdsNo"/>
    <result property="memId" column="memId"/>
    <result property="reWritingDate" column="reWritingDate"/>
    <result property="reUpdateDate" column="reUpdateDate"/>
    <result property="reStatus" column="reStatus"/>
    <result property="reContent" column="reContent"/>
    <result property="fileGroupNo" column="fileGroupNo"/>

    <!-- ✅ FileDetailVO 매핑 -->
    <collection property="fileDetailVOList" ofType="kr.or.ddit.vo.FileDetailVO">
        <id property="fileSn" column="fileSn"/>
        <result property="fileOriginalName" column="fileOriginalName"/>
        <result property="fileSaveName" column="fileSaveName"/>
        <result property="fileSaveLocate" column="fileSaveLocate"/>
        <result property="fileSize" column="fileSize"/>
        <result property="fileExt" column="fileExt"/>
        <result property="fileMime" column="fileMime"/>
    </collection>
</resultMap>


    <!-- ✅ 특정 상품의 리뷰 목록 조회 -->
   <select id="getReviewsByGdsNo" resultMap="ReviewResultMap">
    SELECT 
        R.RE_NO AS reNo,
        R.GDS_NO AS gdsNo,
        R.MEM_ID AS memId,
        R.RE_WRITING_DATE AS reWritingDate,
        R.RE_UPDATE_DATE AS reUpdateDate,
        R.RE_STATUS AS reStatus,
        R.RE_CONTENT AS reContent,
        R.FILE_GROUP_NO AS fileGroupNo,
        F.FILE_SN AS fileSn,
        F.FILE_ORIGINAL_NAME AS fileOriginalName,
        F.FILE_SAVE_NAME AS fileSaveName,
        F.FILE_SAVE_LOCATE AS fileSaveLocate,
        F.FILE_SIZE AS fileSize,
        F.FILE_EXT AS fileExt,
        F.FILE_MIME AS fileMime
    FROM REVIEW R
    LEFT JOIN FILE_DETAIL F ON R.FILE_GROUP_NO = F.FILE_GROUP_NO
    WHERE R.GDS_NO = #{gdsNo}
    AND R.RE_STATUS = 1
    ORDER BY R.RE_WRITING_DATE DESC
</select>




    <!-- ✅ 리뷰 등록 -->
    <insert id="insertReview" parameterType="kr.or.ddit.vo.ReviewVO">
    INSERT INTO REVIEW (
        RE_NO, GDS_NO, MEM_ID, RE_WRITING_DATE, RE_UPDATE_DATE,
        RE_STATUS, RE_CONTENT, FILE_GROUP_NO
    ) VALUES (
        SEQ_REVIEW.NEXTVAL, #{gdsNo}, #{memId}, SYSDATE, SYSDATE, 
        1, #{reContent}, #{fileGroupNo}
    )
</insert>


    <!-- ✅ 리뷰 삭제 (Soft Delete) -->
    <update id="deleteReview" parameterType="int">
    UPDATE REVIEW 
    SET RE_STATUS = 0
    WHERE RE_NO = #{reNo}
</update>

  <!-- ✅ 리뷰 수정 (Update) -->
   <update id="updateReview" parameterType="kr.or.ddit.vo.ReviewVO">
    UPDATE REVIEW 
    SET 
        RE_CONTENT = #{reContent},
        RE_UPDATE_DATE = SYSDATE,
        FILE_GROUP_NO = #{fileGroupNo}
    WHERE 
        RE_NO = #{reNo}
</update>

</mapper>
