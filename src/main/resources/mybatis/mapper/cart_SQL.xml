<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.page.shop.mapper.CartMapper">

<!-- 특정 회원의 가장 최근 CART_STATE 조회 -->
 <select id="selectRecentCartState" parameterType="string" resultType="int">
        SELECT CART_STATE
        FROM CART
        WHERE MEM_ID = #{memId}
        ORDER BY CART_NO DESC
        FETCH FIRST 1 ROWS ONLY
    </select>
    <!-- 장바구니(CART) 등록 -->
    <insert id="insertCart" parameterType="kr.or.ddit.vo.CartVO">
        <selectKey keyProperty="cartNo" resultType="int" order="BEFORE">
            SELECT CART_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO CART (CART_NO, CART_STATE, MEM_ID)
        VALUES (#{cartNo}, #{cartState}, #{memId})
    </insert>

    <!-- 특정 회원의 최근 장바구니 조회 -->
    <select id="selectRecentCartById" parameterType="string" resultType="kr.or.ddit.vo.CartVO">
        SELECT CART_NO, CART_STATE, MEM_ID
        FROM CART
        WHERE MEM_ID = #{memId}
        ORDER BY CART_NO DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 장바구니(CART) 상태 업데이트 -->
    <update id="updateCartState" parameterType="map">
        UPDATE CART
        SET CART_STATE = #{cartState}
        WHERE CART_NO = #{cartNo}
    </update>

    <!-- 장바구니(CART) 삭제 -->
    <delete id="deleteCart" parameterType="int">
        DELETE FROM CART
        WHERE CART_NO = #{cartNo}
    </delete>

    <!-- 특정 회원의 장바구니와 상세 항목 조회 -->
    <select id="selectCartWithDetails" parameterType="string" resultMap="cartWithDetailsMap">
        SELECT 
            c.CART_NO, 
            c.CART_STATE, 
            c.MEM_ID,
            cd.GDS_NO, 
            cd.CART_DETAIL_QY, 
            g.GDS_NM, 
            g.GDS_PRICE, 
            g.GDS_DC,
            g.FILE_GROUP_NO,
             FG.FILE_REGDATE,
            fd.FILE_SAVE_LOCATE
            
        FROM CART c
        LEFT JOIN CART_DETAIL cd ON c.CART_NO = cd.CART_NO
        LEFT JOIN GOODS g ON cd.GDS_NO = g.GDS_NO
        LEFT OUTER JOIN FILE_GROUP FG ON(G.FILE_GROUP_NO  = FG.FILE_GROUP_NO)
        LEFT OUTER JOIN FILE_DETAIL FD ON(FG.FILE_GROUP_NO = FD.FILE_GROUP_NO)
        WHERE c.MEM_ID = #{memId}
          AND c.CART_STATE = 1
    </select>

    <!-- Result Map: 장바구니와 상세 항목의 매핑 -->
    <resultMap id="cartWithDetailsMap" type="kr.or.ddit.vo.CartVO">
        <id property="cartNo" column="CART_NO" />
        <result property="cartState" column="CART_STATE" />
        <result property="memId" column="MEM_ID" />
        <collection property="cartDetails" ofType="kr.or.ddit.vo.CartDetailVO">
            <id property="gdsNo" column="GDS_NO" />
            <result property="cartDetailQy" column="CART_DETAIL_QY" />
            <association property="goods" javaType="kr.or.ddit.vo.GoodsVO">
                <result property="gdsNm" column="GDS_NM" />
                <result property="gdsPrice" column="GDS_PRICE" />
                <result property="gdsDc" column="GDS_DC" />
            </association>
            <association property="fileGroupVO" resultMap="fileGroupMap"></association>
        </collection>
    </resultMap>
    
    <!-- 파일그룹 : 파일상세 = 1 : N -->
	<resultMap type="kr.or.ddit.vo.FileGroupVO" id="fileGroupMap">
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileRegdate" column="FILE_REGDATE"/>
		<collection property="fileDetailVOList" resultMap="fileDetailMap"></collection>
	</resultMap>
	
	<resultMap type="kr.or.ddit.vo.FileDetailVO" id="fileDetailMap">
		<result property="fileSn" column="FILE_SN"/>
		<result property="fileGroupNo" column="FILE_GROUP_NO"/>
		<result property="fileOriginalName" column="FILE_ORIGINAL_NAME"/>
		<result property="fileSaveName" column="FILE_SAVE_NAME"/>
		<result property="fileSaveLocate" column="FILE_SAVE_LOCATE"/>
		<result property="fileSize" column="FILE_SIZE"/>
		<result property="fileExt" column="FILE_EXT"/>
		<result property="fileMime" column="FILE_MIME"/>
		<result property="fileFancysize" column="FILE_FANCYSIZE"/>
		<result property="fileSaveDate" column="FILE_SAVE_DATE"/>
		<result property="fileDowncount" column="FILE_DOWNCOUNT"/>
	</resultMap>

</mapper>
