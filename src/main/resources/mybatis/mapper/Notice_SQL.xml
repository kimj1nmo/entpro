<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.page.notice.mapper.NoticeMapper">

<resultMap type="kr.or.ddit.vo.NoticeVO" id="noticeMap">
	<result property="ntceBoardNo" column="NTCE_BOARD_NO"/>
	<result property="ntceBoardTtl" column="NTCE_BOARD_TTL"/>
	<result property="ntceBoardCn" column="NTCE_BOARD_CN"/>
	<result property="memId" column="MEM_ID"/>
	<result property="regDate" column="REG_DATE"/>
	<result property="memId" column="MEM_ID"/>
	<result property="fileGroupNo" column="FILE_GROUP_NO"/>
	<association property="fileGroupVO" resultMap="fileGroupMap"></association>
</resultMap>
<!-- FILE_GROUP : FILE_DETAIL = 1 : N -->
<resultMap type="kr.or.ddit.vo.FileGroupVO" id="fileGroupMap">
	<result property="fileGroupNo" column="FILE_GROUP_NO"/>
	<result property="fileRegdate" column="FILE_REGDATE"/>
	<collection property="fileDetailVOList" resultMap="fileDetailMap"></collection>
</resultMap>

<resultMap type="kr.or.ddit.vo.FileDetailVO" id="fileDetailMap">
	<result property="fileSn" column="FILE_SN"/>
	<result property="fileGroupNo" column="FILE_GROUP_NO"/>
	<result property="fileOriginalName" column="FILE_ORIGINAL_NAME"/>
	<result property="fileSaveName" column="FILE_SAVE_NAME"/>
	<result property="fileSaveLocate" column="FILE_SAVE_LOCATE"/>
	<result property="fileSize" column="FILE_SIZE"/>
	<result property="fileExt" column="FILE_EXT"/>
	<result property="fileMime" column="FILE_MIME"/>
	<result property="fileFancysize" column="FILE_FANCYSIZE"/>
	<result property="fileSaveDate" column="FILE_SAVE_DATE"/>
	<result property="fileDowncount" column="FILE_DOWNCOUNT"/>
</resultMap>

<!-- noticeAjax -> map : {currentPage=2, keyword=버스} -->
<sql id="where">
	<if test="keyword!=null and keyword!=''">
		AND (
		NTCE_BOARD_TTL   LIKE  '%' || #{keyword} || '%'
		)
	</if>
</sql>


<!-- noticeAjax -> map : {currentPage=2, keyword=버스} -->
<select id="getTotal" parameterType="hashMap" resultType="int">
		SELECT COUNT(*) FROM NOTICE_BOARD
		WHERE 1 = 1
	<include refid="where"></include>
</select>


<select id="list" parameterType="String" resultMap="noticeMap">
		SELECT T.RNUM, T.NTCE_BOARD_NO, T.NTCE_BOARD_TTL, T.NTCE_BOARD_CN, T.MEM_ID, T.REG_DATE, T.FILE_GROUP_NO
		, FG.FILE_REGDATE
		, FD.FILE_SN, FD.FILE_ORIGINAL_NAME
		, FD.FILE_SAVE_NAME, FD.FILE_SAVE_LOCATE, FD.FILE_SIZE
		, FD.FILE_EXT, FD.FILE_MIME, FD.FILE_FANCYSIZE
		, FD.FILE_SAVE_DATE, FD.FILE_DOWNCOUNT
		FROM (
		SELECT ROW_NUMBER() OVER(ORDER BY NTCE_BOARD_NO) RNUM,
		NTCE_BOARD_NO, NTCE_BOARD_TTL, NTCE_BOARD_CN, MEM_ID, to_char(REG_DATE, 'yyyy-mm-dd') reg_date, FILE_GROUP_NO
		FROM NOTICE_BOARD 
		WHERE 1 = 1	
	<include refid="where"></include>
		) T LEFT OUTER JOIN FILE_GROUP FG ON(T.FILE_GROUP_NO  = FG.FILE_GROUP_NO)
		LEFT OUTER JOIN FILE_DETAIL FD ON(FG.FILE_GROUP_NO = FD.FILE_GROUP_NO)
		WHERE T.RNUM BETWEEN (#{currentPage} * 10) -(10-1) AND (#{currentPage} * 10)
</select>



<insert id="createPostAjax" parameterType="kr.or.ddit.vo.NoticeVO">
	<selectKey resultType="int" order="BEFORE" keyProperty="ntceBoardNo">
		SELECT NVL(MAX(ntce_board_no),0)+1 FROM NOTICE_BOARD
	</selectKey>
		INSERT INTO notice_board (ntce_board_no, ntce_board_ttl, ntce_board_cn, reg_date, mem_id
	<if test="fileGroupNo!=null and fileGroupNo !=''">
		, FILE_GROUP_NO
	</if>
		) VALUES 
		(#{ntceBoardNo}, #{ntceBoardTtl}, #{ntceBoardCn}, sysdate, #{memId}
	<if test="fileGroupNo!=null and fileGroupNo !=''">
		, #{fileGroupNo}
	</if>
	)
</insert>

<update id="updatePostAjax" parameterType="kr.or.ddit.vo.NoticeVO">
		UPDATE NOTICE_BOARD
		SET NTCE_BOARD_TTL = #{ntceBoardTtl}
		, NTCE_BOARD_CN = #{ntceBoardCn}
	<if test="fileGroupNo!=null and fileGroupNo !=''">
		, FILE_GROUP_NO = #{fileGroupNo}
	</if>
		WHERE NTCE_BOARD_NO = #{ntceBoardNo}
</update>

<delete id="deletePostAjax" parameterType="kr.or.ddit.vo.NoticeVO">
	DELETE FROM NOTICE_BOARD
	WHERE NTCE_BOARD_NO = #{ntceBoardNo}
</delete>
</mapper>